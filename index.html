<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Joey's Restaurant - Bestelsysteem</title>
<style>
  /* Basic Reset & Fonts */
  * { box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin:0; background:#fff8f0; color:#3c3c3c;
  }
  header {
    background:#d80000; color:white; padding:10px 20px; font-size: 24px; font-weight: bold;
    display:flex; align-items:center; cursor:pointer;
  }
  header img {
    height: 32px; margin-right:10px;
  }
  main {
    padding: 15px;
  }
  /* Tabs */
  #tabsContainer {
    display:flex; gap: 10px; margin-bottom:15px; flex-wrap: wrap;
  }
  #tabsContainer span {
    background:#fcd34d; color:#81191e; font-weight:700;
    padding: 8px 15px; border-radius: 20px; cursor:pointer;
    user-select:none;
    transition: background 0.3s ease;
  }
  #tabsContainer span.active, #tabsContainer span:hover {
    background:#b22222; color:white;
  }
  /* Products Grid */
  #productsContainer {
    display:grid; grid-template-columns: repeat(auto-fill,minmax(160px,1fr));
    gap: 15px;
  }
  .productCard {
    background:white; border-radius: 8px; padding: 12px; box-shadow: 0 2px 6px rgb(216 68 68 / 0.3);
    display:flex; flex-direction: column; align-items:center;
    cursor:pointer; user-select:none;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }
  .productCard:hover:not(.disabled) {
    transform: scale(1.05);
    box-shadow: 0 6px 12px rgb(216 68 68 / 0.6);
  }
  .productCard.disabled {
    opacity: 0.4; cursor: not-allowed;
    pointer-events:none;
  }
  .productCard img {
    max-width: 100%; max-height: 100px; margin-bottom:8px; border-radius:6px;
  }
  .productCard strong {
    font-size: 1.1rem; margin-bottom: 4px;
  }
  /* Cart Button */
  #cartBtn {
    position: fixed; bottom: 20px; right: 20px;
    background:#d80000; color:white; border:none;
    padding: 14px 22px; border-radius: 28px; font-size: 18px;
    box-shadow: 0 4px 12px rgb(216 68 68 / 0.6);
    cursor:pointer; user-select:none;
    z-index: 1000;
    transition: background 0.3s ease;
  }
  #cartBtn:hover {
    background:#a40000;
  }
  /* Cart Overlay */
  #cartOverlay {
    display:none;
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    z-index: 2000;
    justify-content:center; align-items:center;
  }
  #cartContent {
    background: white; border-radius: 12px;
    width: 320px; max-width: 90vw; max-height: 80vh;
    display:flex; flex-direction: column;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  }
  #cartContent header {
    padding: 15px; font-size: 20px; font-weight: 700; border-bottom: 1px solid #eee;
    display: flex; justify-content: space-between; align-items:center;
  }
  #closeCartBtn {
    background: transparent; border:none; font-size: 24px; cursor:pointer; color:#d80000;
  }
  #cartList {
    flex-grow: 1; overflow-y: auto; padding: 15px;
  }
  .cartItem {
    display:flex; justify-content: space-between; align-items:center;
    margin-bottom: 12px; font-weight: 600;
  }
  .cartQty {
    margin-right: 6px; background:#d80000; color:white; border-radius: 14px; padding: 2px 8px;
    font-size: 14px;
  }
  .cartItem button {
    background:#d80000; border:none; border-radius: 5px;
    color:white; cursor:pointer; font-weight: 700; font-size: 16px;
    padding: 0 6px;
  }
  #orderNoteLabel {
    margin: 10px 15px 5px;
    font-weight: 700;
  }
  #orderNote {
    margin: 0 15px 10px;
    width: calc(100% - 30px);
    min-height: 60px;
    padding: 8px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
    resize: vertical;
  }
  #placeOrderBtn {
    background:#d80000; border:none; color:white; font-size: 18px;
    padding: 14px; border-radius: 30px;
    margin: 0 15px 15px;
    cursor:pointer;
    font-weight: 700;
    box-shadow: 0 4px 10px rgb(216 68 68 / 0.8);
    transition: background 0.3s ease;
  }
  #placeOrderBtn:hover {
    background:#a40000;
  }
  /* Login Screen */
  #loginScreen {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 3000;
  }
  #loginBox {
    background: white;
    padding: 30px 35px;
    border-radius: 14px;
    width: 320px;
    box-shadow: 0 8px 18px rgba(0,0,0,0.3);
    display:flex; flex-direction: column; gap: 18px;
  }
  #loginBox h2 {
    margin: 0 0 10px;
    font-weight: 700;
    color: #d80000;
    text-align: center;
  }
  #loginBox label {
    font-weight: 600;
    font-size: 14px;
  }
  #loginBox input, #loginBox select {
    width: 100%;
    padding: 8px 10px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 8px;
  }
  #loginBtn {
    background: #d80000;
    border: none;
    padding: 12px;
    font-weight: 700;
    font-size: 18px;
    color: white;
    border-radius: 25px;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  #loginBtn:hover {
    background: #a40000;
  }
  /* Operator Screen */
  #operatorScreen {
    display: none;
    padding: 15px;
    font-size: 14px;
    color: #333;
  }
  #ordersContainer {
    display: flex;
    gap: 20px;
  }
  #inProgressOrders, #readyOrders {
    flex: 1;
    background: #fef5f5;
    border-radius: 12px;
    padding: 12px;
    height: 70vh;
    overflow-y: auto;
    box-shadow: 0 0 10px rgba(216, 68, 68, 0.15);
  }
  #inProgressOrders h3, #readyOrders h3 {
    margin-top: 0;
    color: #d80000;
  }
  .orderItem {
    padding: 8px 10px;
    margin-bottom: 8px;
    border-radius: 8px;
    cursor: pointer;
    background: #fee5e5;
    transition: background 0.2s ease;
    font-weight: 700;
  }
  .orderItem:hover {
    background: #d44e4e;
    color: white;
  }
  .orderItem.ready {
    background: #d6efd6;
    color: #2d662d;
  }
  .orderItem.delayed {
    background: #fff3cd;
    color: #856404;
  }
  /* Order Details Box */
  #orderDetails {
    display: none;
    margin-top: 20px;
    background: #fff4f4;
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 0 10px rgb(216 68 68 / 0.3);
  }
  #orderDetails p {
    margin: 6px 0;
  }
  #orderDetails ul {
    margin: 6px 0 15px 20px;
  }
  #orderStatusSelect, #orderNoteInput {
    width: 100%;
    padding: 8px 10px;
    margin-bottom: 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }
  #saveOrderBtn, #deleteOrderBtn, #closeOrderDetailsBtn {
    background: #d80000;
    color: white;
    border: none;
    padding: 10px 16px;
    margin-right: 10px;
    border-radius: 25px;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  #saveOrderBtn:hover, #deleteOrderBtn:hover, #closeOrderDetailsBtn:hover {
    background: #a40000;
  }
  /* Product Management */
  #productManagement {
    margin-top: 30px;
  }
  #tabsList {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 10px;
  }
  #tabsList div {
    background: #d80000;
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 700;
    user-select:none;
  }
  #tabsList div.active {
    background: #a40000;
  }
  #productList {
    max-height: 180px;
    overflow-y: auto;
    border: 1px solid #d80000;
    border-radius: 8px;
    padding: 6px 10px;
    background: #fff4f4;
    margin-bottom: 10px;
  }
  #productList div {
    padding: 6px 6px;
    border-bottom: 1px solid #d80000;
    cursor: pointer;
  }
  #productList div:hover {
    background: #d44e4e;
    color: white;
  }
  #productForm {
    display: flex; flex-direction: column; gap: 10px;
  }
  #productForm input, #productForm select {
    padding: 8px 10px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }
  #productForm label {
    font-weight: 700;
  }
  #saveProductBtn, #resetProductBtn, #addTabBtn {
    background: #d80000;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 25px;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  #saveProductBtn:hover, #resetProductBtn:hover, #addTabBtn:hover {
    background: #a40000;
  }
  #addTabInput {
    padding: 8px 10px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
    margin-bottom: 10px;
  }
  /* Display Screen */
  #displayScreen {
    display: none;
    padding: 15px;
  }
  #displayLists {
    display: flex; justify-content: space-between; gap: 30px;
  }
  #inProgressList, #readyList {
    flex: 1;
    border-radius: 12px;
    padding: 15px;
    height: 80vh;
    overflow-y: auto;
    font-weight: 700;
    font-size: 2rem;
    text-align: center;
    user-select:none;
  }
  #inProgressList {
    background: #d7b28a;
    color: #6b3e0f;
    display: flex; flex-wrap: wrap; gap: 25px; align-content: flex-start; justify-content: center;
  }
  #readyList {
    background: #b7d6b7;
    color: #2d662d;
    display: flex; flex-wrap: wrap; gap: 25px; align-content: flex-start; justify-content: center;
  }
  #inProgressList div, #readyList div {
    background: #f7f7f7;
    border-radius: 20px;
    padding: 15px 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    cursor: default;
    user-select:none;
  }
</style>
</head>
<body>

<header id="header">
  <img src="RLogo.jpg" alt="Logo" />
  Joey's Restaurant
</header>

<main>
  <div id="tabsContainer"></div>
  <div id="productsContainer"></div>
</main>

<button id="cartBtn" aria-label="Open winkelwagen">ðŸ›’ Winkelwagen (0)</button>

<!-- Winkelwagen Overlay -->
<div id="cartOverlay" aria-modal="true" role="dialog" aria-labelledby="cartTitle" tabindex="-1">
  <div id="cartContent">
    <header>
      <span id="cartTitle">Winkelwagen</span>
      <button id="closeCartBtn" aria-label="Sluit winkelwagen">&times;</button>
    </header>
    <div id="cartList"></div>
    <label for="orderNote" id="orderNoteLabel">Opmerking bij bestelling (optioneel)</label>
    <textarea id="orderNote" placeholder="Bijvoorbeeld: Geen ui, extra saus..."></textarea>
    <button id="placeOrderBtn">Bestelling plaatsen</button>
  </div>
</div>

<!-- Login Screen -->
<div id="loginScreen" aria-modal="true" role="dialog" tabindex="-1">
  <div id="loginBox">
    <h2>Inloggen</h2>
    <label for="loginTypeSelect">Account type:</label>
    <select id="loginTypeSelect">
      <option value="operator">Operator</option>
      <option value="display">Display</option>
    </select>
    <label for="loginUsername">Gebruikersnaam:</label>
    <input type="text" id="loginUsername" autocomplete="username" />
    <label for="loginPassword">Wachtwoord:</label>
    <input type="password" id="loginPassword" autocomplete="current-password" />
    <button id="loginBtn">Inloggen</button>
  </div>
</div>

<!-- Operator Screen -->
<div id="operatorScreen">
  <h2>Operator Panel</h2>
  <div id="ordersContainer">
    <div id="inProgressOrders"></div>
    <div id="readyOrders"></div>
  </div>

  <div id="orderDetails">
    <h3>Bestelling Details</h3>
    <div id="orderInfo"></div>
    <label for="orderStatusSelect">Status wijzigen:</label>
    <select id="orderStatusSelect">
      <option value="In behandeling">In behandeling</option>
      <option value="Klaar">Klaar</option>
      <option value="Kan (Tijdstip) langer duren">Kan (Tijdstip) langer duren</option>
    </select>
    <label for="orderNoteInput">Opmerking toevoegen:</label>
    <textarea id="orderNoteInput" placeholder="Opmerking operator (optioneel)"></textarea>
    <div>
      <button id="saveOrderBtn">Opslaan</button>
      <button id="deleteOrderBtn">Verwijderen</button>
      <button id="closeOrderDetailsBtn">Sluiten</button>
    </div>
  </div>

  <hr />

  <h2>Product & Tab beheer</h2>
  <input type="text" id="addTabInput" placeholder="Nieuwe tab naam" />
  <button id="addTabBtn">Tab toevoegen</button>
  <div id="tabsList"></div>
  <div id="productList"></div>
  <form id="productForm" onsubmit="return false;">
    <label for="productNameInput">Naam:</label>
    <input type="text" id="productNameInput" />
    <label for="productPriceInput">Prijs (â‚¬):</label>
    <input type="number" id="productPriceInput" min="0" step="0.01" />
    <label for="productPhotoInput">Foto URL:</label>
    <input type="text" id="productPhotoInput" />
    <label for="productAvailabilitySelect">Beschikbaar:</label>
    <select id="productAvailabilitySelect">
      <option value="true">Op voorraad</option>
      <option value="false">Uitverkocht</option>
    </select>
    <button id="saveProductBtn">Opslaan product</button>
    <button id="resetProductBtn">Reset formulier</button>
  </form>
</div>

<!-- Display Screen -->
<div id="displayScreen">
  <h2>Bestellingen Display</h2>
  <div id="displayLists">
    <div id="inProgressList" aria-label="Bestellingen in behandeling"></div>
    <div id="readyList" aria-label="Bestellingen klaar"></div>
  </div>
  <audio id="doneSound" src="JR/Sounds/DoneSoundForScreen.mp3" preload="auto"></audio>
</div>

<script>
  // Config & API keys
  const orderBinId = '688f6efe7b4b8670d8ac3f46';
  const orderApiKey = '$2a$10$XpZeyd.RhynC0Ie0VWma7uJPbMYdUAIHuG24Smc5V0C5LU5d11H5O';
  const productBinId = '689091d47b4b8670d8acd414';
  const productApiKey = '$2a$10$XpZeyd.RhynC0Ie0VWma7uJPbMYdUAIHuG24Smc5V0C5LU5d11H5O';

  // State
  let currentUser = 'Customer'; // 'Customer' | 'Operator' | 'Display'
  let ordersCache = [];
  let allProductsData = {};
  let activeTab = null;
  let cart = {};
  let selectedOrderId = null;
  let activeManageTab = null;
  let editingProductIndex = null;

  // Elements
  const header = document.getElementById('header');
  const tabsContainer = document.getElementById('tabsContainer');
  const productsContainer = document.getElementById('productsContainer');
  const cartBtn = document.getElementById('cartBtn');
  const cartOverlay = document.getElementById('cartOverlay');
  const cartList = document.getElementById('cartList');
  const orderNote = document.getElementById('orderNote');
  const placeOrderBtn = document.getElementById('placeOrderBtn');
  const closeCartBtn = document.getElementById('closeCartBtn');

  const loginScreen = document.getElementById('loginScreen');
  const loginTypeSelect = document.getElementById('loginTypeSelect');
  const loginUsername = document.getElementById('loginUsername');
  const loginPassword = document.getElementById('loginPassword');
  const loginBtn = document.getElementById('loginBtn');

  const operatorScreen = document.getElementById('operatorScreen');
  const inProgressOrders = document.getElementById('inProgressOrders');
  const readyOrders = document.getElementById('readyOrders');
  const orderDetails = document.getElementById('orderDetails');
  const orderInfo = document.getElementById('orderInfo');
  const orderStatusSelect = document.getElementById('orderStatusSelect');
  const orderNoteInput = document.getElementById('orderNoteInput');
  const saveOrderBtn = document.getElementById('saveOrderBtn');
  const deleteOrderBtn = document.getElementById('deleteOrderBtn');
  const closeOrderDetailsBtn = document.getElementById('closeOrderDetailsBtn');

  const addTabInput = document.getElementById('addTabInput');
  const addTabBtn = document.getElementById('addTabBtn');
  const tabsList = document.getElementById('tabsList');
  const productList = document.getElementById('productList');
  const productNameInput = document.getElementById('productNameInput');
  const productPriceInput = document.getElementById('productPriceInput');
  const productPhotoInput = document.getElementById('productPhotoInput');
  const productAvailabilitySelect = document.getElementById('productAvailabilitySelect');
  const saveProductBtn = document.getElementById('saveProductBtn');
  const resetProductBtn = document.getElementById('resetProductBtn');

  const displayScreen = document.getElementById('displayScreen');
  const inProgressList = document.getElementById('inProgressList');
  const readyList = document.getElementById('readyList');
  const doneSound = document.getElementById('doneSound');

  // Helpers
  function saveUserType(type) {
    localStorage.setItem('userType', type);
    currentUser = type;
  }
  function loadUserType() {
    const t = localStorage.getItem('userType');
    if(t) currentUser = t;
  }

  // Render klant menu tabs
  function renderTabs() {
    tabsContainer.innerHTML = '';
    if(!allProductsData) return;
    const tabKeys = Object.keys(allProductsData);
    if(tabKeys.length === 0) {
      tabsContainer.innerHTML = '<p>Geen tabs beschikbaar</p>';
      return;
    }
    tabKeys.forEach(tab => {
      const span = document.createElement('span');
      span.textContent = tab;
      if(tab === activeTab) span.classList.add('active');
      span.onclick = () => {
        activeTab = tab;
        renderTabs();
        renderProducts();
      };
      tabsContainer.appendChild(span);
    });
    if(!activeTab) {
      activeTab = tabKeys[0];
      renderTabs();
      renderProducts();
    }
  }

  // Render producten klant view
  function renderProducts() {
    productsContainer.innerHTML = '';
    if(!activeTab || !allProductsData[activeTab]) return;
    allProductsData[activeTab].forEach((prod, idx) => {
      const card = document.createElement('div');
      card.className = 'productCard';
      if(!prod.beschikbaar) card.classList.add('disabled');
      card.tabIndex = 0;
      // Img
      if(prod.foto) {
        const img = document.createElement('img');
        img.src = prod.foto;
        img.alt = prod.naam;
        card.appendChild(img);
      }
      const nameEl = document.createElement('strong');
      nameEl.textContent = prod.naam;
      card.appendChild(nameEl);
      const priceEl = document.createElement('span');
      priceEl.textContent = `â‚¬${prod.prijs.toFixed(2)}`;
      card.appendChild(priceEl);
      card.onclick = () => {
        if(!prod.beschikbaar) return;
        addToCart(prod);
      };
      productsContainer.appendChild(card);
    });
  }

  // Add product to cart
  function addToCart(product) {
    if(!cart[product.naam]) cart[product.naam] = { ...product, qty: 0 };
    cart[product.naam].qty++;
    updateCartButton();
  }

  // Update cart button text
  function updateCartButton() {
    let count = 0;
    for(let key in cart) count += cart[key].qty;
    cartBtn.textContent = `ðŸ›’ Winkelwagen (${count})`;
    if(count > 0) {
      cartBtn.style.display = 'block';
    } else {
      cartBtn.style.display = 'none';
    }
  }

  // Show cart overlay
  function showCart() {
    renderCartList();
    cartOverlay.style.display = 'flex';
    orderNote.focus();
  }

  // Hide cart overlay
  function hideCart() {
    cartOverlay.style.display = 'none';
  }

  // Render cart list
  function renderCartList() {
    cartList.innerHTML = '';
    for(let key in cart) {
      const item = cart[key];
      const div = document.createElement('div');
      div.className = 'cartItem';
      const qtySpan = document.createElement('span');
      qtySpan.className = 'cartQty';
      qtySpan.textContent = item.qty;
      div.appendChild(qtySpan);
      const nameSpan = document.createElement('span');
      nameSpan.textContent = item.naam;
      div.appendChild(nameSpan);
      const rmBtn = document.createElement('button');
      rmBtn.textContent = 'Ã—';
      rmBtn.title = 'Verwijder item';
      rmBtn.onclick = (e) => {
        e.stopPropagation();
        removeFromCart(item.naam);
      };
      div.appendChild(rmBtn);
      cartList.appendChild(div);
    }
  }

  // Remove product from cart
  function removeFromCart(name) {
    if(cart[name]) {
      delete cart[name];
      updateCartButton();
      renderCartList();
    }
  }

  // Place order handler
  async function placeOrder() {
    if(Object.keys(cart).length === 0) {
      alert('Je winkelwagen is leeg.');
      return;
    }
    const opmerkingKlant = orderNote.value.trim();

    try {
      // Load existing orders to get latest id
      const res = await fetch(`https://api.jsonbin.io/v3/b/${orderBinId}/latest`, {
        headers: { 'X-Master-Key': orderApiKey }
      });
      if(!res.ok) throw new Error('Fout bij ophalen bestellingen');
      const data = await res.json();
      const currentRecord = data.record || {};
      let bestellingen = currentRecord.bestellingen || [];
      let orderCounter = currentRecord.counter || 0;

      // Maak nieuwe bestelling
      orderCounter++;
      const newOrder = {
        id: orderCounter,
        producten: Object.values(cart).map(p => ({
          naam: p.naam,
          prijs: p.prijs,
          qty: p.qty
        })),
        status: 'In behandeling',
        tijdstip: new Date().toISOString(),
        opmerkingKlant: opmerkingKlant,
        opmerkingOperator: ''
      };
      bestellingen.push(newOrder);

      // Update bin met nieuwe bestelling en counter
      currentRecord.bestellingen = bestellingen;
      currentRecord.counter = orderCounter;

      const putRes = await fetch(`https://api.jsonbin.io/v3/b/${orderBinId}`, {
        method: 'PUT',
        headers: {
          'X-Master-Key': orderApiKey,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(currentRecord)
      });
      if(!putRes.ok) throw new Error('Fout bij opslaan bestelling');

      // Reset cart
      cart = {};
      updateCartButton();
      orderNote.value = '';

      // Toon keep-open scherm
      showKeepOpenScreen(newOrder.id);

    } catch(e) {
      alert('Fout bij plaatsen bestelling: ' + e.message);
    }
  }

  // Keep open scherm voor klant
  function showKeepOpenScreen(orderId) {
    main.style.display = 'none';
    cartBtn.style.display = 'none';
    tabsContainer.style.display = 'none';
    productsContainer.style.display = 'none';

    // Maak scherm
    const keepOpenDiv = document.createElement('div');
    keepOpenDiv.id = 'keepOpenScreen';
    keepOpenDiv.style.cssText = `
      position: fixed; inset: 0; background: #d80000; color: white;
      display:flex; flex-direction: column; justify-content: center; align-items: center;
      font-size: 24px; font-weight: 700; text-align: center; z-index: 5000;
    `;
    keepOpenDiv.innerHTML = `
      <p>Bestelling geplaatst! Je bestelnummer is:</p>
      <p style="font-size: 48px; margin: 15px 0;">#${orderId}</p>
      <p>Laat deze pagina open totdat je bestelling klaar is.</p>
      <button id="keepOpenBackBtn" style="margin-top:30px; font-size:18px; background:white; color:#d80000; border:none; border-radius: 12px; padding: 12px 20px; cursor:pointer;">Terug naar menu</button>
    `;
    document.body.appendChild(keepOpenDiv);

    document.getElementById('keepOpenBackBtn').onclick = () => {
      keepOpenDiv.remove();
      showCustomerUI();
    };
  }

  // Show klant UI
  function showCustomerUI() {
    currentUser = 'Customer';
    saveUserType(currentUser);

    if(document.getElementById('keepOpenScreen')) {
      document.getElementById('keepOpenScreen').remove();
    }
    main.style.display = 'block';
    cartBtn.style.display = Object.keys(cart).length > 0 ? 'block' : 'none';
    tabsContainer.style.display = 'flex';
    productsContainer.style.display = 'grid';

    operatorScreen.style.display = 'none';
    displayScreen.style.display = 'none';
    loginScreen.style.display = 'none';
  }

  // Login screen functies
  function showLoginScreen() {
    loginScreen.style.display = 'flex';
    loginUsername.value = '';
    loginPassword.value = '';
    loginTypeSelect.value = 'operator';
    loginUsername.focus();
  }
  function hideLoginScreen() {
    loginScreen.style.display = 'none';
  }

  // Login afhandelen
  function handleLogin() {
    const type = loginTypeSelect.value;
    const user = loginUsername.value.trim();
    const pass = loginPassword.value;

    if(type === 'operator') {
      if(user === 'Operator' && pass === '8008') {
        currentUser = 'Operator';
        saveUserType(currentUser);
        hideLoginScreen();
        showOperatorUI();
      } else {
        alert('Onjuiste gebruikersnaam of wachtwoord');
      }
    } else if(type === 'display') {
      if(user === 'OperatorScreen' && pass === '8008') {
        currentUser = 'Display';
        saveUserType(currentUser);
        hideLoginScreen();
        showDisplayUI();
      } else {
        alert('Onjuiste gebruikersnaam of wachtwoord');
      }
    }
  }

  // Operator UI tonen
  function showOperatorUI() {
    main.style.display = 'none';
    cartBtn.style.display = 'none';
    tabsContainer.style.display = 'none';
    productsContainer.style.display = 'none';
    operatorScreen.style.display = 'block';
    displayScreen.style.display = 'none';

    selectedOrderId = null;
    orderDetails.style.display = 'none';

    loadOrders();
    loadProductsData();
  }

  // Display UI tonen
  function showDisplayUI() {
    main.style.display = 'none';
    cartBtn.style.display = 'none';
    tabsContainer.style.display = 'none';
    productsContainer.style.display = 'none';
    operatorScreen.style.display = 'none';
    displayScreen.style.display = 'block';

    loadOrders();
  }

  // Laden van bestellingen
  async function loadOrders() {
    try {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${orderBinId}/latest`, {
        headers: { 'X-Master-Key': orderApiKey }
      });
      if(!res.ok) throw new Error('Kon bestellingen niet ophalen');
      const data = await res.json();
      const record = data.record || {};
      ordersCache = record.bestellingen || [];
      renderOrders();
    } catch(e) {
      console.error(e);
    }
  }

  // Render orders operator & display
  function renderOrders() {
    if(currentUser === 'Operator') {
      inProgressOrders.innerHTML = '<h3>In behandeling</h3>';
      readyOrders.innerHTML = '<h3>Klaar</h3>';

      ordersCache.forEach(order => {
        const div = document.createElement('div');
        div.className = 'orderItem';
        div.textContent = `#${order.id} - ${order.status}`;
        if(order.status === 'Klaar') div.classList.add('ready');
        else if(order.status.includes('langer')) div.classList.add('delayed');
        div.onclick = () => {
          selectedOrderId = order.id;
          showOrderDetails(order);
        };
        if(order.status === 'Klaar') {
          readyOrders.appendChild(div);
        } else {
          inProgressOrders.appendChild(div);
        }
      });
    } else if(currentUser === 'Display') {
      inProgressList.innerHTML = '';
      readyList.innerHTML = '';
      ordersCache.forEach(order => {
        const div = document.createElement('div');
        div.textContent = `#${order.id}`;
        if(order.status === 'Klaar') {
          readyList.appendChild(div);
        } else {
          inProgressList.appendChild(div);
        }
      });
    }
  }

  // Toon details van een bestelling (operator)
  function showOrderDetails(order) {
    orderDetails.style.display = 'block';
    orderInfo.innerHTML = `
      <p><strong>Bestelnummer:</strong> #${order.id}</p>
      <p><strong>Status:</strong> ${order.status}</p>
      <p><strong>Besteld op:</strong> ${new Date(order.tijdstip).toLocaleString()}</p>
      <p><strong>Opmerking klant:</strong> ${order.opmerkingKlant || 'Geen'}</p>
      <p><strong>Producten:</strong></p>
      <ul>${order.producten.map(p => `<li>${p.naam} x${p.qty} (â‚¬${p.prijs.toFixed(2)})</li>`).join('')}</ul>
    `;
    orderStatusSelect.value = order.status;
    orderNoteInput.value = order.opmerkingOperator || '';
  }

  // Save order wijziging
  async function saveOrderChanges() {
    if(selectedOrderId === null) return;

    const status = orderStatusSelect.value;
    const opmerkingOperator = orderNoteInput.value.trim();

    // Update in cache
    const order = ordersCache.find(o => o.id === selectedOrderId);
    if(!order) return;

    order.status = status;
    order.opmerkingOperator = opmerkingOperator;

    try {
      // Update jsonbin
      const res = await fetch(`https://api.jsonbin.io/v3/b/${orderBinId}/latest`, {
        headers: { 'X-Master-Key': orderApiKey }
      });
      if(!res.ok) throw new Error('Kon bestellingen niet ophalen');
      const data = await res.json();
      const record = data.record || {};

      // Update order in record
      record.bestellingen = record.bestellingen.map(o => o.id === selectedOrderId ? order : o);

      const putRes = await fetch(`https://api.jsonbin.io/v3/b/${orderBinId}`, {
        method: 'PUT',
        headers: {
          'X-Master-Key': orderApiKey,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(record)
      });
      if(!putRes.ok) throw new Error('Kon bestelling niet opslaan');

      alert('Bestelling opgeslagen!');
      loadOrders();
      orderDetails.style.display = 'none';

    } catch(e) {
      alert('Fout bij opslaan bestelling: ' + e.message);
    }
  }

  // Delete order
  async function deleteOrder() {
    if(selectedOrderId === null) return;
    if(!confirm('Weet je zeker dat je deze bestelling wilt verwijderen?')) return;

    try {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${orderBinId}/latest`, {
        headers: { 'X-Master-Key': orderApiKey }
      });
      if(!res.ok) throw new Error('Kon bestellingen niet ophalen');
      const data = await res.json();
      const record = data.record || {};

      record.bestellingen = record.bestellingen.filter(o => o.id !== selectedOrderId);

      const putRes = await fetch(`https://api.jsonbin.io/v3/b/${orderBinId}`, {
        method: 'PUT',
        headers: {
          'X-Master-Key': orderApiKey,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(record)
      });
      if(!putRes.ok) throw new Error('Kon bestelling niet verwijderen');

      alert('Bestelling verwijderd!');
      selectedOrderId = null;
      orderDetails.style.display = 'none';
      loadOrders();
    } catch(e) {
      alert('Fout bij verwijderen bestelling: ' + e.message);
    }
  }

  // Close order details
  function closeOrderDetails() {
    selectedOrderId = null;
    orderDetails.style.display = 'none';
  }

  // Load producten & tabs
  async function loadProductsData() {
    try {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${productBinId}/latest`, {
        headers: { 'X-Master-Key': productApiKey }
      });
      if(!res.ok) throw new Error('Kon producten niet ophalen');
      const data = await res.json();
      const record = data.record || {};

      allProductsData = record.tabs || {};

      // Default fallback tabs if missing
      const defaultTabs = ['Drank', 'Fingerfood', "Menu's", 'Dessert', 'Salades'];
      defaultTabs.forEach(t => {
        if(!(t in allProductsData)) allProductsData[t] = [];
      });

      renderTabs();
      renderProducts();
      renderTabsManagement();
    } catch(e) {
      console.error(e);
    }
  }

  // Render tabs in product beheer (operator)
  function renderTabsManagement() {
    tabsList.innerHTML = '';
    Object.keys(allProductsData).forEach(tab => {
      const div = document.createElement('div');
      div.textContent = tab;
      if(tab === activeManageTab) div.classList.add('active');
      div.onclick = () => {
        activeManageTab = tab;
        renderTabsManagement();
        renderProductList();
        resetProductForm();
      };
      tabsList.appendChild(div);
    });
    if(!activeManageTab) {
      activeManageTab = Object.keys(allProductsData)[0] || null;
      renderTabsManagement();
      renderProductList();
    }
  }

  // Render product list beheer
  function renderProductList() {
    productList.innerHTML = '';
    if(!activeManageTab || !allProductsData[activeManageTab]) return;
    allProductsData[activeManageTab].forEach((prod, i) => {
      const div = document.createElement('div');
      div.textContent = prod.naam;
      div.onclick = () => {
        editingProductIndex = i;
        fillProductForm(prod);
      };
      productList.appendChild(div);
    });
  }

  // Vul product formulier
  function fillProductForm(prod) {
    productNameInput.value = prod.naam;
    productPriceInput.value = prod.prijs;
    productPhotoInput.value = prod.foto;
    productAvailabilitySelect.value = prod.beschikbaar ? 'true' : 'false';
  }

  // Reset product formulier
  function resetProductForm() {
    editingProductIndex = null;
    productNameInput.value = '';
    productPriceInput.value = '';
    productPhotoInput.value = '';
    productAvailabilitySelect.value = 'true';
  }

  // Save product (toevoegen of wijzigen)
  async function saveProduct() {
    if(!activeManageTab) {
      alert('Selecteer eerst een tab');
      return;
    }
    const naam = productNameInput.value.trim();
    const prijs = parseFloat(productPriceInput.value);
    const foto = productPhotoInput.value.trim();
    const beschikbaar = productAvailabilitySelect.value === 'true';

    if(!naam || isNaN(prijs)) {
      alert('Vul een geldige naam en prijs in');
      return;
    }

    if(!allProductsData[activeManageTab]) allProductsData[activeManageTab] = [];

    if(editingProductIndex !== null) {
      // Wijzig product
      allProductsData[activeManageTab][editingProductIndex] = { naam, prijs, foto, beschikbaar };
    } else {
      // Nieuw product
      allProductsData[activeManageTab].push({ naam, prijs, foto, beschikbaar });
    }

    try {
      // Update JSONBin
      const res = await fetch(`https://api.jsonbin.io/v3/b/${productBinId}/latest`, {
        headers: { 'X-Master-Key': productApiKey }
      });
      if(!res.ok) throw new Error('Kon producten niet ophalen');
      const data = await res.json();
      const record = data.record || {};

      record.tabs = allProductsData;

      const putRes = await fetch(`https://api.jsonbin.io/v3/b/${productBinId}`, {
        method: 'PUT',
        headers: {
          'X-Master-Key': productApiKey,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(record)
      });
      if(!putRes.ok) throw new Error('Kon producten niet opslaan');

      alert('Product opgeslagen!');
      resetProductForm();
      renderProductList();
      renderProducts();

    } catch(e) {
      alert('Fout bij opslaan product: ' + e.message);
    }
  }

  // Reset product formulier handler
  function resetProduct() {
    resetProductForm();
  }

  // Voeg nieuwe tab toe
  async function addTab() {
    const tabNaam = addTabInput.value.trim();
    if(!tabNaam) {
      alert('Vul een geldige tabnaam in');
      return;
    }
    if(tabNaam in allProductsData) {
      alert('Tab bestaat al');
      return;
    }
    allProductsData[tabNaam] = [];
    addTabInput.value = '';

    try {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${productBinId}/latest`, {
        headers: { 'X-Master-Key': productApiKey }
      });
      if(!res.ok) throw new Error('Kon producten niet ophalen');
      const data = await res.json();
      const record = data.record || {};

      record.tabs = allProductsData;

      const putRes = await fetch(`https://api.jsonbin.io/v3/b/${productBinId}`, {
        method: 'PUT',
        headers: {
          'X-Master-Key': productApiKey,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(record)
      });
      if(!putRes.ok) throw new Error('Kon tab niet opslaan');

      alert('Tab toegevoegd!');
      renderTabsManagement();

    } catch(e) {
      alert('Fout bij toevoegen tab: ' + e.message);
    }
  }

  // Event listeners
  cartBtn.onclick = showCart;
  closeCartBtn.onclick = hideCart;
  placeOrderBtn.onclick = placeOrder;
  loginBtn.onclick = handleLogin;
  saveOrderBtn.onclick = saveOrderChanges;
  deleteOrderBtn.onclick = deleteOrder;
  closeOrderDetailsBtn.onclick = closeOrderDetails;
  saveProductBtn.onclick = saveProduct;
  resetProductBtn.onclick = resetProduct;
  addTabBtn.onclick = addTab;

  // Init
  loadUserType();

  if(currentUser === 'Customer') showCustomerUI();
  else if(currentUser === 'Operator') showOperatorUI();
  else if(currentUser === 'Display') showDisplayUI();

  // Polling every 5 seconds for real-time sync
  setInterval(() => {
    loadOrders();
    if(currentUser === 'Operator') loadProductsData();
  }, 5000);

  // Keyboard shortcut to open login screen for operator or display
  document.addEventListener('keydown', e => {
    if(e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'z') {
      showLoginScreen();
    }
  });

  // Display plays sound when order status changes to 'Klaar'
  let lastReadyOrderIds = new Set();
  function checkAndPlayDoneSound() {
    if(currentUser !== 'Display') return;
    const readyOrders = ordersCache.filter(o => o.status === 'Klaar').map(o => o.id);
    const newReady = readyOrders.filter(id => !lastReadyOrderIds.has(id));
    if(newReady.length > 0) {
      doneSound.play();
      lastReadyOrderIds = new Set(readyOrders);
    }
  }

  // Check done sound every 5 seconds
  setInterval(checkAndPlayDoneSound, 5000);

</script>
</body>
</html>
