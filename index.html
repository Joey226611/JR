<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Joey's Restaurant Bestelsysteem</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .hidden { display: none; }
  .tab-btn {
    @apply px-4 py-2 rounded hover:bg-yellow-300 transition;
  }
  .tab-btn-active {
    @apply bg-yellow-400 text-black font-bold;
  }
</style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

<header class="flex justify-between items-center p-4 bg-white shadow">
  <img src="RLogo.jpg" alt="Logo" class="h-12" />
  <button id="operatorLoginBtn" class="bg-yellow-400 px-3 py-1 rounded hover:bg-yellow-500 transition">Operator Login</button>
</header>

<!-- Gasten Bestelscherm -->
<main id="guestView" class="flex-grow p-4 max-w-3xl mx-auto">
  <nav class="flex space-x-2 mb-4">
    <button class="tab-btn tab-btn-active" data-tab="drinks">Drinks</button>
    <button class="tab-btn" data-tab="fingerfood">Fingerfood</button>
    <button class="tab-btn" data-tab="desserts">Desserts</button>
    <button class="tab-btn" data-tab="menus">Menus</button>
  </nav>

  <section id="drinks" class="tab-content">
    <h2 class="text-xl font-semibold mb-2">Drinks</h2>
    <div class="grid grid-cols-2 gap-4">
      <button class="bg-white p-4 rounded shadow hover:bg-yellow-100 transition" data-name="Cola" data-price="1.5">Cola - â‚¬1.50</button>
      <button class="bg-white p-4 rounded shadow hover:bg-yellow-100 transition" data-name="Water" data-price="1.0">Water - â‚¬1.00</button>
    </div>
  </section>

  <section id="fingerfood" class="tab-content hidden">
    <h2 class="text-xl font-semibold mb-2">Fingerfood</h2>
    <div class="grid grid-cols-2 gap-4">
      <button class="bg-white p-4 rounded shadow hover:bg-yellow-100 transition" data-name="Pringles Natural" data-price="0.1">Pringles Natural (per chip) - â‚¬0.10</button>
      <button class="bg-white p-4 rounded shadow hover:bg-yellow-100 transition" data-name="Pringles BBQ" data-price="0.12">Pringles BBQ (per chip) - â‚¬0.12</button>
    </div>
  </section>

  <section id="desserts" class="tab-content hidden">
    <h2 class="text-xl font-semibold mb-2">Desserts</h2>
    <p>Coming soon!</p>
  </section>

  <section id="menus" class="tab-content hidden">
    <h2 class="text-xl font-semibold mb-2">Menus</h2>
    <p>Coming soon!</p>
  </section>

  <!-- Winkelmandje icoon -->
  <button id="cartBtn" class="fixed bottom-6 right-6 bg-yellow-400 p-5 rounded-full shadow-lg hover:bg-yellow-500 transition z-40">ðŸ›’</button>
</main>

<!-- Popup om aantal te kiezen en afrekenen/doorshoppen -->
<div id="itemPopup" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white rounded-lg p-6 w-80 max-w-full shadow-lg">
    <h3 id="popupItemName" class="text-xl font-bold mb-4"></h3>
    <label class="block mb-2">Aantal (max 50):</label>
    <input id="popupQty" type="number" min="1" max="50" value="1" class="border rounded px-3 py-1 w-full mb-4" />
    <div class="flex justify-between">
      <button id="popupAddMore" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400 transition">Verder winkelen</button>
      <button id="popupCheckout" class="bg-yellow-400 px-4 py-2 rounded hover:bg-yellow-500 transition">Afrekenen</button>
    </div>
  </div>
</div>

<!-- Winkelmandje view -->
<div id="cartView" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white rounded-lg p-6 w-96 max-w-full shadow-lg max-h-[80vh] overflow-auto flex flex-col">
    <h3 class="text-2xl font-bold mb-4">Winkelmandje</h3>
    <ul id="cartItems" class="flex-grow overflow-auto space-y-2"></ul>
    <div class="mt-4 flex justify-between">
      <button id="placeOrderBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition">Bestelling plaatsen</button>
      <button id="closeCartBtn" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400 transition">Verder winkelen</button>
    </div>
  </div>
</div>

<!-- Operator login modal -->
<div id="operatorLoginModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white rounded-lg p-6 w-80 max-w-full shadow-lg">
    <h3 class="text-xl font-bold mb-4">Operator Login</h3>
    <input id="operatorUsername" placeholder="Gebruikersnaam" class="border rounded px-3 py-2 w-full mb-3" />
    <input id="operatorPassword" type="password" placeholder="Wachtwoord" class="border rounded px-3 py-2 w-full mb-5" />
    <div class="flex justify-end space-x-2">
      <button id="operatorLoginCancel" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400 transition">Annuleren</button>
      <button id="operatorLoginSubmit" class="bg-yellow-400 px-4 py-2 rounded hover:bg-yellow-500 transition">Login</button>
    </div>
  </div>
</div>

<!-- Operator bestellingen scherm -->
<main id="operatorView" class="hidden p-6 max-w-4xl mx-auto flex-grow flex flex-col">
  <h2 class="text-3xl font-bold mb-6">Operator: Bestellingen Overzicht</h2>
  <button id="operatorLogoutBtn" class="self-end bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition mb-4">Logout</button>
  <div id="ordersList" class="flex flex-col gap-4 overflow-auto flex-grow"></div>

  <!-- Bestelling detail modal -->
  <div id="orderDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
    <div class="bg-white rounded-lg p-6 w-96 max-w-full shadow-lg max-h-[80vh] overflow-auto flex flex-col">
      <h3 class="text-2xl font-bold mb-4">Bestelling Details</h3>
      <div id="orderDetailsContent" class="flex-grow overflow-auto"></div>
      <label class="block mt-4 mb-1 font-semibold">Status:</label>
      <select id="orderStatusSelect" class="border rounded px-3 py-2 w-full mb-3">
        <option value="pending">In Behandeling</option>
        <option value="ready">Klaar</option>
        <option value="delay">Kan (tijdstip) langer duren</option>
      </select>
      <label class="block mb-1 font-semibold">Extra tekst (optioneel):</label>
      <textarea id="orderExtraText" rows="3" class="border rounded px-3 py-2 w-full mb-4" placeholder="Bijv. \"Wordt nu bereid door chef Mario ðŸ\""></textarea>
      <div class="flex justify-between">
        <button id="deleteOrderBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition">Bestelling Verwijderen</button>
        <button id="closeOrderDetailBtn" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400 transition">Sluiten</button>
      </div>
    </div>
  </div>
</main>

<script>
(() => {
  // State
  let cart = [];
  let currentPopupItem = null;
  let orders = [];
  let selectedOrderIndex = null;
  let operatorLoggedIn = false;

  // DOM Elements
  const guestView = document.getElementById('guestView');
  const operatorView = document.getElementById('operatorView');
  const operatorLoginBtn = document.getElementById('operatorLoginBtn');
  const operatorLoginModal = document.getElementById('operatorLoginModal');
  const operatorLoginCancel = document.getElementById('operatorLoginCancel');
  const operatorLoginSubmit = document.getElementById('operatorLoginSubmit');
  const operatorLogoutBtn = document.getElementById('operatorLogoutBtn');

  const cartBtn = document.getElementById('cartBtn');
  const cartView = document.getElementById('cartView');
  const cartItemsList = document.getElementById('cartItems');
  const placeOrderBtn = document.getElementById('placeOrderBtn');
  const closeCartBtn = document.getElementById('closeCartBtn');

  const itemPopup = document.getElementById('itemPopup');
  const popupItemName = document.getElementById('popupItemName');
  const popupQty = document.getElementById('popupQty');
  const popupAddMore = document.getElementById('popupAddMore');
  const popupCheckout = document.getElementById('popupCheckout');

  const ordersList = document.getElementById('ordersList');

  const orderDetailModal = document.getElementById('orderDetailModal');
  const orderDetailsContent = document.getElementById('orderDetailsContent');
  const orderStatusSelect = document.getElementById('orderStatusSelect');
  const orderExtraText = document.getElementById('orderExtraText');
  const deleteOrderBtn = document.getElementById('deleteOrderBtn');
  const closeOrderDetailBtn = document.getElementById('closeOrderDetailBtn');

  // Tabs guests
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');

  // JSONBin config
  const JSONBIN_ID = '688f6efe7b4b8670d8ac3f46';
  const JSONBIN_APIKEY = '$2a$10$XpZeyd.RhynC0Ie0VWma7uJPbMYdUAIHuG24Smc5V0C5LU5d11H5O';

  // Helper: fetch orders from JSONBin
  async function fetchOrders() {
    try {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_ID}/latest`, {
        headers: { 'X-Master-Key': JSONBIN_APIKEY }
      });
      const data = await res.json();
      orders = data.record.orders || [];
      renderOrdersList();
    } catch (e) {
      console.error('Error fetching orders:', e);
    }
  }

  // Helper: save orders to JSONBin
  async function saveOrders() {
    try {
      await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_ID}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': JSONBIN_APIKEY,
        },
        body: JSON.stringify({ orders }),
      });
    } catch (e) {
      console.error('Error saving orders:', e);
    }
  }

  // Render orders list for operator
  function renderOrdersList() {
    ordersList.innerHTML = '';
    orders.forEach((order, i) => {
      const div = document.createElement('div');
      div.className = 'bg-white p-4 rounded shadow cursor-pointer hover:bg-yellow-100';
      div.textContent = `Bestelling ${i + 1} - ${order.time}`;
      div.addEventListener('click', () => {
        selectedOrderIndex = i;
        openOrderDetail();
      });
      ordersList.appendChild(div);
    });
  }

  // Open order detail popup for operator
  function openOrderDetail() {
    if (selectedOrderIndex === null) return;
    const order = orders[selectedOrderIndex];
    orderDetailsContent.innerHTML = order.items
      .map(i => `<div>${i.qty}x ${i.name}</div>`).join('');
    orderStatusSelect.value = order.status || 'pending';
    orderExtraText.value = order.extraText || '';
    orderDetailModal.classList.remove('hidden');
  }

  // Close order detail popup
  function closeOrderDetail() {
    orderDetailModal.classList.add('hidden');
    selectedOrderIndex = null;
  }

  // Delete order
  async function deleteOrder() {
    if (selectedOrderIndex === null) return;
    orders.splice(selectedOrderIndex, 1);
    await saveOrders();
    await fetchOrders();
    closeOrderDetail();
  }

  // Update order status and extra text
  async function updateOrder() {
    if (selectedOrderIndex === null) return;
    orders[selectedOrderIndex].status = orderStatusSelect.value;
    orders[selectedOrderIndex].extraText = orderExtraText.value;
    await saveOrders();
    await fetchOrders();
    closeOrderDetail();
  }

  // Login operator
  function openOperatorLogin() {
    operatorLoginModal.classList.remove('hidden');
  }
  function closeOperatorLogin() {
    operatorLoginModal.classList.add('hidden');
  }
  function operatorLogin() {
    const user = document.getElementById('operatorUsername').value.trim();
    const pass = document.getElementById('operatorPassword').value.trim();
    if (user === 'Operator' && pass === '8008') {
      operatorLoggedIn = true;
      guestView.classList.add('hidden');
      operatorView.classList.remove('hidden');
      closeOperatorLogin();
      fetchOrders();
    } else {
      alert('Verkeerde gebruikersnaam of wachtwoord');
    }
  }
  function operatorLogout() {
    operatorLoggedIn = false;
    operatorView.classList.add('hidden');
    guestView.classList.remove('hidden');
  }

  // Tab switching
  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      tabButtons.forEach(b => b.classList.remove('tab-btn-active'));
      btn.classList.add('tab-btn-active');
      const tab = btn.getAttribute('data-tab');
      tabContents.forEach(c => {
        if (c.id === tab) c.classList.remove('hidden');
        else c.classList.add('hidden');
      });
    });
  });

  // Guest add to cart flow - show popup
  function onGuestItemClick(e) {
    const target = e.target.closest('button[data-name]');
    if (!target) return;
    currentPopupItem = {
      name: target.getAttribute('data-name'),
      price: parseFloat(target.getAttribute('data-price')),
    };
    popupItemName.textContent = `${currentPopupItem.name} - â‚¬${currentPopupItem.price.toFixed(2)}`;
    popupQty.value = 1;
    itemPopup.classList.remove('hidden');
  }

  // Add to cart helper
  function addToCart(name, price, qty) {
    let found = cart.find(i => i.name === name);
    if (found) {
      found.qty += qty;
    } else {
      cart.push({ name, price, qty });
    }
  }

  // Popup buttons handlers
  popupAddMore.addEventListener('click', () => {
    const qty = Math.min(Math.max(parseInt(popupQty.value), 1), 50);
    addToCart(currentPopupItem.name, currentPopupItem.price, qty);
    itemPopup.classList.add('hidden');
  });

  popupCheckout.addEventListener('click', () => {
    const qty = Math.min(Math.max(parseInt(popupQty.value), 1), 50);
    addToCart(currentPopupItem.name, currentPopupItem.price, qty);
    itemPopup.classList.add('hidden');
    openCartView();
  });

  // Show cart view
  function openCartView() {
    renderCartItems();
    cartView.classList.remove('hidden');
  }
  // Close cart view
  function closeCartView() {
    cartView.classList.add('hidden');
  }

  // Render cart items
  function renderCartItems() {
    cartItemsList.innerHTML = '';
    if (cart.length === 0) {
      cartItemsList.innerHTML = '<li>Je winkelmandje is leeg</li>';
      placeOrderBtn.disabled = true;
      placeOrderBtn.classList.add('opacity-50', 'cursor-not-allowed');
      return;
    }
    placeOrderBtn.disabled = false;
    placeOrderBtn.classList.remove('opacity-50', 'cursor-not-allowed');

    cart.forEach((item, i) => {
      const li = document.createElement('li');
      li.className = 'flex justify-between items-center';
      li.innerHTML = `
        <div>${item.qty}x ${item.name} (â‚¬${(item.price * item.qty).toFixed(2)})</div>
        <button data-index="${i}" class="text-red-500 hover:text-red-700 font-bold">Ã—</button>
      `;
      const btn = li.querySelector('button');
      btn.addEventListener('click', () => {
        cart.splice(i, 1);
        renderCartItems();
      });
      cartItemsList.appendChild(li);
    });
  }

  // Place order to JSONBin
  async function placeOrder() {
    if (cart.length === 0) return alert('Je winkelmandje is leeg!');
    // Create order object
    const now = new Date();
    const timeStr = now.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });
    const order = {
      time: timeStr,
      items: cart.map(i => ({ name: i.name, price: i.price, qty: i.qty })),
      status: 'pending',
      extraText: ''
    };
    orders.push(order);
    await saveOrders();
    await fetchOrders();
    cart = [];
    closeCartView();
    alert('Bestelling geplaatst! Bedankt.');
  }

  // Event listeners
  document.querySelectorAll('[data-name]').forEach(btn => {
    btn.addEventListener('click', onGuestItemClick);
  });
  cartBtn.addEventListener('click', openCartView);
  closeCartBtn.addEventListener('click', closeCartView);
  placeOrderBtn.addEventListener('click', placeOrder);

  operatorLoginBtn.addEventListener('click', openOperatorLogin);
  operatorLoginCancel.addEventListener('click', closeOperatorLogin);
  operatorLoginSubmit.addEventListener('click', operatorLogin);
  operatorLogoutBtn.addEventListener('click', operatorLogout);

  deleteOrderBtn.addEventListener('click', async () => {
    if (confirm('Weet je zeker dat je deze bestelling wilt verwijderen?')) {
      await deleteOrder();
    }
  });
  closeOrderDetailBtn.addEventListener('click', async () => {
    await updateOrder();
    closeOrderDetail();
  });

  orderStatusSelect.addEventListener('change', updateOrder);
  orderExtraText.addEventListener('input', updateOrder);

  // Polling for new orders every 5 seconds
  setInterval(() => {
    if (operatorLoggedIn) {
      fetchOrders();
    }
  }, 5000);

})();
</script>

</body>
</html>
