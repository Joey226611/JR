<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Joey's Restaurant - Bestelsysteem</title>
<style>
  /* --- Algemeen --- */
  body {
    margin:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#fff8e1; color:#333;
    display:flex; flex-direction: column; min-height: 100vh;
  }
  #header {
    background:#d80000; color:#fff; padding: 12px 20px; font-weight: 900; font-size: 24px;
    cursor:pointer;
    user-select:none;
  }
  #header:hover {
    background:#b30000;
  }

  main {
    flex:1; display:flex; flex-direction: column; padding: 10px 20px;
  }

  /* --- Tabs Klant --- */
  #tabsContainer {
    display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;
  }
  #tabsContainer span {
    cursor:pointer;
    padding: 8px 16px;
    background: #f9c74f;
    border-radius: 30px;
    font-weight: 700;
    color:#5b3a00;
    user-select:none;
    transition: background 0.3s;
  }
  #tabsContainer span.active, #tabsContainer span:hover {
    background:#f9844a; color:#fff;
  }

  /* --- Producten Klant --- */
  #productsContainer {
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(150px,1fr));
    gap: 15px;
  }
  .productCard {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
    padding: 10px;
    cursor: pointer;
    display: flex; flex-direction: column; align-items: center;
    user-select:none;
    transition: transform 0.15s;
  }
  .productCard:hover {
    transform: scale(1.05);
  }
  .productCard.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .productCard img {
    max-width: 100%; max-height: 100px; object-fit: contain; margin-bottom: 8px;
  }
  .productCard strong {
    font-size: 16px; margin-bottom: 4px; color: #333;
  }
  .productCard span {
    font-weight: 700; color: #d80000;
  }

  /* --- Winkelwagen --- */
  #cartBtn {
    position: fixed; bottom: 20px; right: 20px;
    background: #d80000; color: white; border:none; border-radius: 50px;
    padding: 12px 20px; font-size: 18px; font-weight: 900;
    cursor:pointer;
    box-shadow: 0 4px 15px rgb(216 0 0 / 0.7);
    display:none;
    user-select:none;
    z-index: 1000;
  }

  #cartOverlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.6);
    justify-content: center; align-items: center;
    z-index: 2000;
  }
  #cartContent {
    background: white;
    padding: 20px;
    border-radius: 16px;
    max-width: 400px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 0 25px rgba(0,0,0,0.3);
    display: flex; flex-direction: column;
  }
  #cartContent h3 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #d80000;
    font-weight: 900;
  }
  .cartItem {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 10px;
  }
  .cartItem span.qty {
    font-weight: 900; margin-right: 10px;
  }
  .cartItem button {
    background: #d80000; color: white; border: none; border-radius: 6px;
    padding: 3px 8px; cursor: pointer; font-weight: 900;
  }
  #orderNote {
    width: 100%;
    margin-top: 10px;
    min-height: 60px;
    border: 2px solid #d80000;
    border-radius: 8px;
    padding: 8px;
    font-size: 14px;
    resize: vertical;
  }
  #placeOrderBtn {
    margin-top: 12px;
    background: #d80000;
    color: white;
    border: none;
    border-radius: 50px;
    padding: 12px 0;
    font-weight: 900;
    font-size: 18px;
    cursor: pointer;
  }
  #closeCartBtn {
    margin-top: 8px;
    background: #555;
    color: white;
    border: none;
    border-radius: 50px;
    padding: 8px 0;
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
  }

  /* --- Login scherm --- */
  #loginScreen {
    display:none;
    position: fixed; inset:0;
    background: rgba(0,0,0,0.6);
    justify-content: center; align-items: center;
    z-index: 3000;
  }
  #loginBox {
    background: white;
    padding: 30px 40px;
    border-radius: 20px;
    width: 320px;
    max-width: 90vw;
    box-shadow: 0 0 30px rgba(0,0,0,0.25);
  }
  #loginBox h2 {
    margin-top: 0; margin-bottom: 20px;
    color: #d80000;
    font-weight: 900;
    text-align: center;
  }
  #loginBox label {
    display: block;
    margin-bottom: 6px;
    font-weight: 700;
  }
  #loginBox input, #loginBox select {
    width: 100%;
    padding: 8px 10px;
    margin-bottom: 16px;
    border-radius: 10px;
    border: 2px solid #d80000;
    font-size: 16px;
    box-sizing: border-box;
  }
  #loginBtn {
    width: 100%;
    padding: 12px;
    background: #d80000;
    border: none;
    border-radius: 50px;
    font-weight: 900;
    color: white;
    font-size: 18px;
    cursor: pointer;
  }
  #loginBtn:hover {
    background: #b30000;
  }

  /* --- Operator scherm --- */
  #operatorScreen {
    display:none;
    flex:1; padding: 10px 20px;
    background:#fff4e1;
  }
  #operatorContent {
    display: flex; gap: 20px; height: 100%;
  }
  #ordersList, #orderDetailContainer, #productManagement {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgb(0 0 0 / 0.15);
    padding: 15px;
    overflow-y: auto;
  }
  #ordersList {
    flex: 1;
    max-width: 300px;
  }
  #ordersList h3 {
    margin-top: 0; color: #d80000; font-weight: 900; text-align:center;
  }
  .orderItem {
    padding: 10px 8px;
    border-bottom: 1px solid #ddd;
    cursor: pointer;
    user-select:none;
  }
  .orderItem.ready {
    background: #d0f0d6;
    color: #2d652d;
    font-weight: 900;
  }
  .orderItem.delayed {
    background: #f7e3e3;
    color: #a32b2b;
    font-weight: 900;
  }
  .orderItem:hover {
    background: #fce2e2;
  }

  #orderDetailContainer {
    flex: 2;
    display: flex; flex-direction: column;
  }
  #orderDetailContainer h3 {
    margin-top: 0; color: #d80000; font-weight: 900; text-align:center;
  }
  #orderDetailsContent {
    flex: 1;
    overflow-y: auto;
    border: 2px solid #d80000;
    border-radius: 12px;
    padding: 15px;
    background: #fff;
    margin-bottom: 15px;
  }
  #orderDetailsContent p {
    margin: 6px 0;
  }
  #orderDetailsContent ul {
    margin: 6px 0 15px 20px;
  }
  #orderDetailsContent ul li {
    margin-bottom: 5px;
  }

  #orderActions {
    display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;
  }
  #orderStatusSelect, #orderNoteInput {
    width: 100%;
    border-radius: 12px;
    border: 2px solid #d80000;
    padding: 10px;
    font-size: 16px;
    box-sizing: border-box;
    font-weight: 700;
  }
  #orderNoteInput {
    min-height: 70px;
    resize: vertical;
    margin-top: 8px;
  }
  #saveOrderBtn, #deleteOrderBtn, #closeOrderDetailsBtn {
    flex: 1;
    background: #d80000;
    border: none;
    border-radius: 50px;
    color: white;
    font-weight: 900;
    font-size: 18px;
    padding: 10px 0;
    cursor: pointer;
    transition: background 0.3s;
  }
  #saveOrderBtn:hover, #deleteOrderBtn:hover, #closeOrderDetailsBtn:hover {
    background: #b30000;
  }

  /* --- Product beheer operator --- */
  #productManagement {
    flex: 1.5;
    display: flex; flex-direction: column;
  }
  #productManagement h3 {
    margin-top: 0; color: #d80000; font-weight: 900; text-align:center;
  }
  #tabsList {
    display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 12px;
  }
  #tabsList div {
    padding: 8px 15px;
    background: #f9c74f;
    border-radius: 30px;
    cursor: pointer;
    user-select:none;
    font-weight: 700;
    color:#5b3a00;
    transition: background 0.3s;
  }
  #tabsList div.active, #tabsList div:hover {
    background:#f9844a; color:#fff;
  }

  #productList {
    flex: 1;
    overflow-y: auto;
    border: 2px solid #d80000;
    border-radius: 12px;
    background: #fff;
    padding: 10px;
    margin-bottom: 10px;
  }
  #productList div {
    padding: 8px 10px;
    cursor: pointer;
    user-select:none;
    border-bottom: 1px solid #ddd;
  }
  #productList div:hover, #productList div.active {
    background: #f9844a;
    color: white;
    font-weight: 900;
  }

  #productForm {
    display: flex; flex-direction: column; gap: 8px;
  }
  #productForm label {
    font-weight: 700;
  }
  #productForm input, #productForm select {
    padding: 8px 10px;
    border-radius: 10px;
    border: 2px solid #d80000;
    font-size: 16px;
  }
  #productFormButtons {
    display: flex; gap: 10px; margin-top: 10px;
  }
  #productFormButtons button {
    flex: 1;
    background: #d80000;
    color: white;
    border: none;
    border-radius: 50px;
    font-weight: 900;
    font-size: 16px;
    padding: 10px 0;
    cursor: pointer;
    transition: background 0.3s;
  }
  #productFormButtons button:hover {
    background: #b30000;
  }

  #addTabContainer {
    margin-top: 10px;
    display: flex; gap: 10px; justify-content: center;
  }
  #addTabInput {
    flex: 1;
    padding: 10px;
    font-size: 16px;
    border-radius: 50px;
    border: 2px solid #d80000;
  }
  #addTabBtn {
    background: #d80000;
    border: none;
    color: white;
    font-weight: 900;
    font-size: 16px;
    border-radius: 50px;
    padding: 10px 20px;
    cursor: pointer;
  }
  #addTabBtn:hover {
    background: #b30000;
  }

  /* --- Display scherm --- */
  #displayScreen {
    display:none;
    padding: 20px;
    background: #fff8e1;
    height: 100vh;
    box-sizing: border-box;
  }
  #displayLists {
    display: flex;
    gap: 40px;
    justify-content: center;
    flex-wrap: wrap;
  }
  #inProgressList, #readyList {
    background: white;
    border-radius: 16px;
    box-shadow: 0 2px 15px rgb(0 0 0 / 0.15);
    padding: 15px 25px;
    min-width: 280px;
    max-width: 320px;
    min-height: 300px;
    font-weight: 900;
    font-size: 42px;
    display: flex;
    flex-wrap: wrap;
    gap: 25px;
    align-content: flex-start;
    color: #5b3a00;
  }
  #inProgressList {
    background: #f7f1e7;
    color: #7a5a00;
  }
  #readyList {
    background: #d0f0d6;
    color: #2d652d;
  }
  #inProgressList > div, #readyList > div {
    background: #f9844a;
    border-radius: 12px;
    padding: 15px 20px;
    min-width: 50px;
    text-align: center;
    cursor: default;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
    user-select:none;
  }

  /* --- Responsive --- */
  @media (max-width: 700px) {
    #productsContainer {
      grid-template-columns: repeat(auto-fill,minmax(130px,1fr));
    }
    #operatorContent {
      flex-direction: column;
    }
    #ordersList, #orderDetailContainer, #productManagement {
      max-height: 300px;
    }
    #displayLists {
      flex-direction: column; gap: 20px;
      align-items: center;
    }
  }
</style>
</head>
<body>

<div id="header" title="Klik om uit te loggen (alleen als ingelogd)">Joey's Restaurant</div>

<main id="mainContent">

  <!-- Klant Bestelmenu -->
  <section id="customerUI">
    <div id="tabsContainer"></div>
    <div id="productsContainer"></div>
    <button id="cartBtn" title="Winkelwagen">🛒</button>
  </section>

  <!-- Winkelwagen Overlay -->
  <div id="cartOverlay">
    <div id="cartContent">
      <h3>Winkelwagen</h3>
      <div id="cartItems"></div>
      <label for="orderNote">Opmerkingen (bijv. allergieën):</label>
      <textarea id="orderNote" placeholder="Typ hier extra opmerkingen..."></textarea>
      <button id="placeOrderBtn">Bestelling plaatsen</button>
      <button id="closeCartBtn">Sluiten</button>
    </div>
  </div>

  <!-- Login scherm -->
  <div id="loginScreen">
    <div id="loginBox">
      <h2>Login</h2>
      <label for="loginTypeSelect">Login type</label>
      <select id="loginTypeSelect">
        <option value="operator">Operator</option>
        <option value="display">Display scherm</option>
      </select>
      <label for="loginUsername">Gebruikersnaam</label>
      <input type="text" id="loginUsername" autocomplete="off" />
      <label for="loginPassword">Wachtwoord</label>
      <input type="password" id="loginPassword" autocomplete="off" />
      <button id="loginBtn">Inloggen</button>
    </div>
  </div>

  <!-- Operator scherm -->
  <section id="operatorScreen">
    <div id="operatorContent">
      <div id="ordersList">
        <h3>Bestellingen</h3>
        <div id="inProgressOrders"></div>
        <div id="readyOrders" style="margin-top: 20px;"></div>
      </div>
      <div id="orderDetailContainer">
        <h3>Bestelling details</h3>
        <div id="orderDetailsContent"></div>
        <select id="orderStatusSelect">
          <option value="In behandeling">In behandeling</option>
          <option value="Klaar">Klaar</option>
          <option value="Kan langer duren">Kan langer duren</option>
        </select>
        <textarea id="orderNoteInput" placeholder="Voeg een opmerking toe..."></textarea>
        <div id="orderActions">
          <button id="saveOrderBtn">Opslaan</button>
          <button id="deleteOrderBtn">Verwijderen</button>
          <button id="closeOrderDetailsBtn">Sluiten</button>
        </div>
      </div>
      <div id="productManagement">
        <h3>Productbeheer</h3>
        <div id="tabsList"></div>
        <div id="productList"></div>
        <form id="productForm" onsubmit="return false;">
          <label for="productNameInput">Naam</label>
          <input type="text" id="productNameInput" autocomplete="off" />
          <label for="productPriceInput">Prijs (€)</label>
          <input type="number" id="productPriceInput" min="0" step="0.01" />
          <label for="productPhotoInput">Foto URL</label>
          <input type="url" id="productPhotoInput" autocomplete="off" />
          <label for="productAvailabilitySelect">Beschikbaar</label>
          <select id="productAvailabilitySelect">
            <option value="true">Op voorraad</option>
            <option value="false">Uitverkocht</option>
          </select>
          <div id="productFormButtons">
            <button id="saveProductBtn">Opslaan</button>
            <button id="resetProductBtn" type="button">Reset</button>
          </div>
        </form>
        <div id="addTabContainer">
          <input type="text" id="addTabInput" placeholder="Nieuwe tab naam" autocomplete="off" />
          <button id="addTabBtn">Tab toevoegen</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Display scherm -->
  <section id="displayScreen">
    <h2 style="text-align:center; color:#d80000; font-weight:900; margin-bottom:30px;">Display Scherm</h2>
    <div id="displayLists">
      <div id="inProgressList" aria-label="In behandeling"></div>
      <div id="readyList" aria-label="Klaar"></div>
    </div>
    <audio id="doneSound" src="JR/Sounds/DoneSoundForScreen.mp3" preload="auto"></audio>
  </section>

</main>

<script>
(() => {
  // --- Config JSONBin ---
  const orderBinId = '688f6efe7b4b8670d8ac3f46'; // jouw bestelling bin id
  const orderApiKey = '$2a$10$XpZeyd.RhynC0Ie0VWma7uJPbMYdUAIHuG24Smc5V0C5LU5d11H5O';

  const productBinId = '689091d47b4b8670d8acd414'; // product bin id
  const productApiKey = '$2a$10$XpZeyd.RhynC0Ie0VWma7uJPbMYdUAIHuG24Smc5V0C5LU5d11H5O';

  // --- Elementen ---
  const header = document.getElementById('header');

  const customerUI = document.getElementById('customerUI');
  const tabsContainer = document.getElementById('tabsContainer');
  const productsContainer = document.getElementById('productsContainer');
  const cartBtn = document.getElementById('cartBtn');
  const cartOverlay = document.getElementById('cartOverlay');
  const cartItems = document.getElementById('cartItems');
  const orderNote = document.getElementById('orderNote');
  const placeOrderBtn = document.getElementById('placeOrderBtn');
  const closeCartBtn = document.getElementById('closeCartBtn');

  const loginScreen = document.getElementById('loginScreen');
  const loginTypeSelect = document.getElementById('loginTypeSelect');
  const loginUsername = document.getElementById('loginUsername');
  const loginPassword = document.getElementById('loginPassword');
  const loginBtn = document.getElementById('loginBtn');

  const operatorScreen = document.getElementById('operatorScreen');
  const inProgressOrders = document.getElementById('inProgressOrders');
  const readyOrders = document.getElementById('readyOrders');
  const orderDetailsContent = document.getElementById('orderDetailsContent');
  const orderStatusSelect = document.getElementById('orderStatusSelect');
  const orderNoteInput = document.getElementById('orderNoteInput');
  const saveOrderBtn = document.getElementById('saveOrderBtn');
  const deleteOrderBtn = document.getElementById('deleteOrderBtn');
  const closeOrderDetailsBtn = document.getElementById('closeOrderDetailsBtn');

  const tabsList = document.getElementById('tabsList');
  const productList = document.getElementById('productList');
  const productNameInput = document.getElementById('productNameInput');
  const productPriceInput = document.getElementById('productPriceInput');
  const productPhotoInput = document.getElementById('productPhotoInput');
  const productAvailabilitySelect = document.getElementById('productAvailabilitySelect');
  const saveProductBtn = document.getElementById('saveProductBtn');
  const resetProductBtn = document.getElementById('resetProductBtn');
  const addTabInput = document.getElementById('addTabInput');
  const addTabBtn = document.getElementById('addTabBtn');

  const displayScreen = document.getElementById('displayScreen');
  const inProgressList = document.getElementById('inProgressList');
  const readyList = document.getElementById('readyList');
  const doneSound = document.getElementById('doneSound');

  // --- State ---
  let currentUser = 'Customer'; // 'Customer', 'Operator', 'Display'
  let ordersCache = [];
  let allProductsData = {};
  let cart = {};
  let activeTab = null;

  let selectedOrderId = null;
  let editingProductIndex = null;
  let activeManageTab = null;

  // --- Helpers JSONBin ---

  async function getLatestRecord(binId, apiKey) {
    const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
      headers: { 'X-Master-Key': apiKey }
    });
    if(!res.ok) throw new Error('Kan data niet ophalen');
    const data = await res.json();
    return data.record;
  }

  async function updateRecord(binId, apiKey, newRecord) {
    const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
      method: 'PUT',
      headers: {
        'X-Master-Key': apiKey,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(newRecord)
    });
    if(!res.ok) throw new Error('Kan data niet opslaan');
  }

  // --- Laden en tonen producten en tabs ---
  async function loadProductsData() {
    try {
      const data = await getLatestRecord(productBinId, productApiKey);
      if(!data.tabs) data.tabs = {};
      allProductsData = data.tabs;
      renderTabsCustomer();
      if(!activeTab) {
        activeTab = Object.keys(allProductsData)[0] || null;
      }
      renderProductsCustomer();
      renderTabsManagement();
      renderProductsManagement();
    } catch(err) {
      alert('Fout bij laden producten: ' + err.message);
    }
  }

  function renderTabsCustomer() {
    tabsContainer.innerHTML = '';
    Object.keys(allProductsData).forEach(tab => {
      const span = document.createElement('span');
      span.textContent = tab;
      span.classList.toggle('active', tab === activeTab);
      span.onclick = () => {
        activeTab = tab;
        renderTabsCustomer();
        renderProductsCustomer();
      };
      tabsContainer.appendChild(span);
    });
  }
  function renderProductsCustomer() {
    productsContainer.innerHTML = '';
    if(!activeTab || !allProductsData[activeTab]) return;
    allProductsData[activeTab].forEach((product, i) => {
      const card = document.createElement('div');
      card.className = 'productCard' + (product.beschikbaar ? '' : ' disabled');
      card.onclick = () => {
        if(!product.beschikbaar) return;
        addToCart(i);
      };
      if(product.foto) {
        const img = document.createElement('img');
        img.src = product.foto;
        img.alt = product.naam;
        card.appendChild(img);
      }
      const strong = document.createElement('strong');
      strong.textContent = product.naam;
      card.appendChild(strong);
      const price = document.createElement('span');
      price.textContent = '€' + product.prijs.toFixed(2);
      card.appendChild(price);
      productsContainer.appendChild(card);
    });
  }

  // --- Winkelwagen functies ---
  function addToCart(productIndex) {
    const product = allProductsData[activeTab][productIndex];
    if(!cart[activeTab]) cart[activeTab] = {};
    if(cart[activeTab][product.naam]) cart[activeTab][product.naam].qty++;
    else cart[activeTab][product.naam] = { ...product, qty:1 };
    updateCartButton();
  }

  function updateCartButton() {
    const totalCount = Object.values(cart).reduce((acc, tabProducts) => {
      return acc + Object.values(tabProducts).reduce((a,b) => a + b.qty, 0);
    }, 0);
    cartBtn.style.display = totalCount > 0 ? 'block' : 'none';
    cartBtn.textContent = `🛒 (${totalCount})`;
  }

  cartBtn.onclick = () => {
    showCart();
  };

  function showCart() {
    renderCartItems();
    cartOverlay.style.display = 'flex';
  }

  closeCartBtn.onclick = () => {
    cartOverlay.style.display = 'none';
  };

  function renderCartItems() {
    cartItems.innerHTML = '';
    Object.entries(cart).forEach(([tabName, products]) => {
      Object.entries(products).forEach(([name, item]) => {
        const div = document.createElement('div');
        div.className = 'cartItem';
        const qtySpan = document.createElement('span');
        qtySpan.className = 'qty';
        qtySpan.textContent = item.qty + 'x';
        div.appendChild(qtySpan);
        const nameSpan = document.createElement('span');
        nameSpan.textContent = name;
        div.appendChild(nameSpan);
        const priceSpan = document.createElement('span');
        priceSpan.textContent = '€' + (item.prijs * item.qty).toFixed(2);
        div.appendChild(priceSpan);
        // knop om item uit winkelwagen te verwijderen
        const delBtn = document.createElement('button');
        delBtn.textContent = 'x';
        delBtn.title = 'Verwijder';
        delBtn.onclick = () => {
          item.qty--;
          if(item.qty <= 0) {
            delete cart[tabName][name];
            if(Object.keys(cart[tabName]).length === 0) {
              delete cart[tabName];
            }
          }
          updateCartButton();
          renderCartItems();
        };
        div.appendChild(delBtn);
        cartItems.appendChild(div);
      });
    });
  }

  // --- Bestelling plaatsen ---
  placeOrderBtn.onclick = async () => {
    if(Object.keys(cart).length === 0) {
      alert('Je winkelwagen is leeg');
      return;
    }
    const noteText = orderNote.value.trim();

    // Laad laatste data + counter
    let data;
    try {
      data = await getLatestRecord(orderBinId, orderApiKey);
    } catch(e) {
      alert('Kan bestelling niet plaatsen, probeer opnieuw');
      return;
    }
    if(!data.orders) data.orders = [];
    if(typeof data.counter !== 'number') data.counter = 0;

    // Nieuwe bestelling nummer
    const newOrderNumber = data.counter + 1;

    // Bouw order object
    const newOrder = {
      id: newOrderNumber,
      items: cart,
      note: noteText,
      status: "In behandeling",
      createdAt: new Date().toISOString()
    };

    // Voeg toe en update counter
    data.orders.push(newOrder);
    data.counter = newOrderNumber;

    try {
      await updateRecord(orderBinId, orderApiKey, data);
      alert(`Bestelling geplaatst! Jouw bestelnummer is #${newOrderNumber}`);
      cart = {};
      updateCartButton();
      orderNote.value = '';
      cartOverlay.style.display = 'none';

      // Ga naar keep open scherm (alert ipv aparte pagina)
      alert(`Hou deze pagina open tot jouw bestelling klaar is.\nBestelnummer: #${newOrderNumber}`);
    } catch(e) {
      alert('Fout bij plaatsen bestelling, probeer opnieuw.');
    }
  };

  // --- Login functies ---
  loginBtn.onclick = () => {
    const type = loginTypeSelect.value;
    const username = loginUsername.value.trim();
    const password = loginPassword.value.trim();

    if(type === 'operator') {
      if(username.toLowerCase() === 'operator' && password === '8008') {
        currentUser = 'Operator';
        showOperatorUI();
        hideLoginScreen();
      } else {
        alert('Ongeldige operator login');
      }
    } else if(type === 'display') {
      if(username.toLowerCase() === 'operatorscreen' && password === '8008') {
        currentUser = 'Display';
        showDisplayUI();
        hideLoginScreen();
      } else {
        alert('Ongeldige display login');
      }
    }
  };

  function showLoginScreen() {
    customerUI.style.display = 'none';
    operatorScreen.style.display = 'none';
    displayScreen.style.display = 'none';
    loginScreen.style.display = 'flex';
    loginUsername.value = '';
    loginPassword.value = '';
  }
  function hideLoginScreen() {
    loginScreen.style.display = 'none';
  }

  // --- UI tonen ---
  function showCustomerUI() {
    currentUser = 'Customer';
    loginScreen.style.display = 'none';
    operatorScreen.style.display = 'none';
    displayScreen.style.display = 'none';
    customerUI.style.display = 'block';
  }
  function showOperatorUI() {
    currentUser = 'Operator';
    loginScreen.style.display = 'none';
    customerUI.style.display = 'none';
    displayScreen.style.display = 'none';
    operatorScreen.style.display = 'flex';
    loadOrders();
    loadProductsData();
  }
  function showDisplayUI() {
    currentUser = 'Display';
    loginScreen.style.display = 'none';
    customerUI.style.display = 'none';
    operatorScreen.style.display = 'none';
    displayScreen.style.display = 'block';
    loadOrders();
  }

  // --- Laden en tonen orders ---
  async function loadOrders() {
    try {
      const data = await getLatestRecord(orderBinId, orderApiKey);
      if(!data.orders) data.orders = [];
      ordersCache = data.orders;
      renderOrders();
      renderDisplayOrders();
    } catch(e) {
      console.error('Fout bij laden orders:', e);
    }
  }

  function renderOrders() {
    if(currentUser !== 'Operator') return;

    inProgressOrders.innerHTML = '<h3>In behandeling</h3>';
    readyOrders.innerHTML = '<h3>Klaar</h3>';

    const inProgress = ordersCache.filter(o => o.status === 'In behandeling' || o.status === 'Kan langer duren');
    const ready = ordersCache.filter(o => o.status === 'Klaar');

    inProgress.forEach(o => {
      const div = document.createElement('div');
      div.textContent = `#${o.id} - ${new Date(o.createdAt).toLocaleTimeString()}`;
      div.className = 'orderItem' + (o.status === 'Kan langer duren' ? ' delayed' : '');
      div.onclick = () => selectOrder(o.id);
      inProgressOrders.appendChild(div);
    });
    ready.forEach(o => {
      const div = document.createElement('div');
      div.textContent = `#${o.id} - ${new Date(o.createdAt).toLocaleTimeString()}`;
      div.className = 'orderItem ready';
      div.onclick = () => selectOrder(o.id);
      readyOrders.appendChild(div);
    });
  }

  function selectOrder(orderId) {
    selectedOrderId = orderId;
    const order = ordersCache.find(o => o.id === orderId);
    if(!order) return;

    let html = `<p><strong>Bestelnummer:</strong> #${order.id}</p>`;
    html += `<p><strong>Status:</strong> ${order.status}</p>`;
    html += `<p><strong>Besteld om:</strong> ${new Date(order.createdAt).toLocaleString()}</p>`;
    html += `<p><strong>Opmerkingen:</strong> ${order.note || '-'}</p>`;
    html += `<p><strong>Bestelde items:</strong></p><ul>`;

    Object.entries(order.items).forEach(([tab, products]) => {
      Object.entries(products).forEach(([name, item]) => {
        html += `<li>${item.qty}x ${name} (€${item.prijs.toFixed(2)} per stuk)</li>`;
      });
    });
    html += '</ul>';

    orderDetailsContent.innerHTML = html;
    orderStatusSelect.value = order.status;
    orderNoteInput.value = order.note || '';
  }

  // --- Order opslaan ---
  saveOrderBtn.onclick = async () => {
    if(selectedOrderId === null) return alert('Selecteer eerst een bestelling');
    const order = ordersCache.find(o => o.id === selectedOrderId);
    if(!order) return alert('Bestelling niet gevonden');

    order.status = orderStatusSelect.value;
    order.note = orderNoteInput.value.trim();

    try {
      const data = await getLatestRecord(orderBinId, orderApiKey);
      data.orders = data.orders.filter(o => o.id !== selectedOrderId);
      data.orders.push(order);
      await updateRecord(orderBinId, orderApiKey, data);
      alert('Bestelling bijgewerkt');
      selectedOrderId = null;
      orderDetailsContent.innerHTML = '';
      loadOrders();
    } catch(e) {
      alert('Fout bij opslaan bestelling: ' + e.message);
    }
  };

  // --- Order verwijderen ---
  deleteOrderBtn.onclick = async () => {
    if(selectedOrderId === null) return alert('Selecteer eerst een bestelling');

    if(!confirm('Weet je zeker dat je deze bestelling wilt verwijderen?')) return;

    try {
      const data = await getLatestRecord(orderBinId, orderApiKey);
      data.orders = data.orders.filter(o => o.id !== selectedOrderId);
      await updateRecord(orderBinId, orderApiKey, data);
      alert('Bestelling verwijderd');
      selectedOrderId = null;
      orderDetailsContent.innerHTML = '';
      loadOrders();
    } catch(e) {
      alert('Fout bij verwijderen bestelling: ' + e.message);
    }
  };

  closeOrderDetailsBtn.onclick = () => {
    selectedOrderId = null;
    orderDetailsContent.innerHTML = '';
  };

  // --- Tabs management ---

  function renderTabsManagement() {
    tabsList.innerHTML = '';
    Object.keys(allProductsData).forEach(tab => {
      const div = document.createElement('div');
      div.textContent = tab;
      div.classList.toggle('active', tab === activeManageTab);
      div.onclick = () => {
        activeManageTab = tab;
        renderTabsManagement();
        renderProductsManagement();
        clearProductForm();
      };
      tabsList.appendChild(div);
    });
    if(!activeManageTab) activeManageTab = Object.keys(allProductsData)[0] || null;
  }

  // --- Product management ---

  function renderProductsManagement() {
    productList.innerHTML = '';
    if(!activeManageTab || !allProductsData[activeManageTab]) return;
    allProductsData[activeManageTab].forEach((product, i) => {
      const div = document.createElement('div');
      div.textContent = product.naam;
      div.classList.toggle('active', i === editingProductIndex);
      div.onclick = () => {
        editingProductIndex = i;
        fillProductForm(product);
        renderProductsManagement();
      };
      productList.appendChild(div);
    });
  }

  function fillProductForm(product) {
    productNameInput.value = product.naam;
    productPriceInput.value = product.prijs;
    productPhotoInput.value = product.foto || '';
    productAvailabilitySelect.value = product.beschikbaar ? 'true' : 'false';
  }

  function clearProductForm() {
    editingProductIndex = null;
    productNameInput.value = '';
    productPriceInput.value = '';
    productPhotoInput.value = '';
    productAvailabilitySelect.value = 'true';
  }

  saveProductBtn.onclick = async () => {
    if(!activeManageTab) return alert('Selecteer eerst een tab');
    const naam = productNameInput.value.trim();
    const prijs = parseFloat(productPriceInput.value);
    const foto = productPhotoInput.value.trim();
    const beschikbaar = productAvailabilitySelect.value === 'true';

    if(!naam || isNaN(prijs)) {
      return alert('Vul naam en prijs correct in');
    }

    if(!allProductsData[activeManageTab]) allProductsData[activeManageTab] = [];

    const newProduct = { naam, prijs, foto, beschikbaar };

    if(editingProductIndex !== null) {
      allProductsData[activeManageTab][editingProductIndex] = newProduct;
    } else {
      allProductsData[activeManageTab].push(newProduct);
    }

    try {
      await saveProducts();
      clearProductForm();
      renderProductsManagement();
      renderTabsCustomer();
      renderProductsCustomer();
    } catch(e) {
      alert('Fout bij opslaan product: ' + e.message);
    }
  };

  resetProductBtn.onclick = () => {
    clearProductForm();
  };

  addTabBtn.onclick = async () => {
    const newTabName = addTabInput.value.trim();
    if(!newTabName) return alert('Voer een naam in voor de tab');
    if(allProductsData[newTabName]) return alert('Tab bestaat al');

    allProductsData[newTabName] = [];
    addTabInput.value = '';
    activeManageTab = newTabName;
    try {
      await saveProducts();
      renderTabsManagement();
      renderTabsCustomer();
      renderProductsManagement();
      renderProductsCustomer();
    } catch(e) {
      alert('Fout bij toevoegen tab: ' + e.message);
    }
  };

  async function saveProducts() {
    // We wrappen de tabs in een object "tabs" om consistent te blijven met JSONBin structuur
    const saveData = { tabs: allProductsData };
    await updateRecord(productBinId, productApiKey, saveData);
  }

  // --- Display scherm rendering ---

  function renderDisplayOrders() {
    if(currentUser !== 'Display') return;
    inProgressList.innerHTML = '';
    readyList.innerHTML = '';

    const inProgress = ordersCache.filter(o => o.status === 'In behandeling' || o.status === 'Kan langer duren');
    const ready = ordersCache.filter(o => o.status === 'Klaar');

    inProgress.forEach(o => {
      const div = document.createElement('div');
      div.textContent = `#${o.id}`;
      inProgressList.appendChild(div);
    });

    // Check welke zijn nieuw klaar en speel geluid
    const oldReadyIds = new Set([...readyList.querySelectorAll('div')].map(d => d.textContent.replace('#','')));
    ready.forEach(o => {
      const idStr = `#${o.id}`;
      if(!oldReadyIds.has(idStr)) {
        doneSound.play().catch(() => {});
      }
      const div = document.createElement('div');
      div.textContent = `#${o.id}`;
      readyList.appendChild(div);
    });
  }

  // --- Header klik = uitloggen terug naar klant ---
  header.onclick = () => {
    if(currentUser !== 'Customer') {
      if(confirm('Weet je zeker dat je wilt uitloggen?')) {
        currentUser = 'Customer';
        showCustomerUI();
      }
    }
  };

  // --- Shortcut CTRL+SHIFT+Z => login scherm ---
  window.addEventListener('keydown', e => {
    if(e.ctrlKey && e.shiftKey && e.code === 'KeyZ') {
      if(currentUser === 'Customer') {
        showLoginScreen();
      }
    }
  });

  // --- Start ---
  showCustomerUI();
  loadProductsData();

  // --- Polling voor realtime updates (elke 3 sec) ---
  setInterval(() => {
    if(currentUser === 'Operator' || currentUser === 'Display') {
      loadOrders();
      if(currentUser === 'Operator') loadProductsData();
    }
  }, 3000);

})();
</script>

</body>
</html>
